/**
 * Returns an SVG string representing a journal group icon.
 *
 * @returns {string} An SVG string of a journal group icon.
 */
function getJournalsSVG() {
    return "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-journals\" viewBox=\"0 0 16 16\"><path d=\"M5 0h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2 2 2 0 0 1-2 2H3a2 2 0 0 1-2-2h1a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1H1a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v9a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1H3a2 2 0 0 1 2-2\"/><path d=\"M1 6v-.5a.5.5 0 0 1 1 0V6h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V9h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 2.5v.5H.5a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1H2v-.5a.5.5 0 0 0-1 0\"/></svg>";

}
/**
 * Returns an SVG string representing a journal icon.
 *
 * @returns {string} An SVG string of a journal icon.
 */
function getJournalSVG() {
    return "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-journal\" viewBox=\"0 0 16 16\"><path d=\"M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2\"/><path d=\"M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1z\"/></svg>";

}
/**
 * Returns an SVG string representing a gear icon.
 *
 * @returns {string} An SVG string of a gear icon.
 */
function getGearSVG() {
    return "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-gear\" viewBox=\"0 0 16 16\"><path d=\"M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0\"/><path d=\"M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z\"/></svg>"
}

/**
 * Generates an SVG string representing a recycle icon.
 *
 * @returns {string} The SVG string for the recycle icon.
 */
function getRecycleSVG() {
    return "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-bootstrap-reboot\" viewBox=\"0 0 16 16\"><path d=\"M1.161 8a6.84 6.84 0 1 0 6.842-6.84.58.58 0 1 1 0-1.16 8 8 0 1 1-6.556 3.412l-.663-.577a.58.58 0 0 1 .227-.997l2.52-.69a.58.58 0 0 1 .728.633l-.332 2.592a.58.58 0 0 1-.956.364l-.643-.56A6.8 6.8 0 0 0 1.16 8z\"/><path d=\"M6.641 11.671V8.843h1.57l1.498 2.828h1.314L9.377 8.665c.897-.3 1.427-1.106 1.427-2.1 0-1.37-.943-2.246-2.456-2.246H5.5v7.352zm0-3.75V5.277h1.57c.881 0 1.416.499 1.416 1.32 0 .84-.504 1.324-1.386 1.324z\"/></svg>";
}

/**
 * Initializes the search box with autocomplete options.
 */
function loadSearch() {
    var options = ['aaaaa', 'bbbbb', 'ccccc', 'ddddd'];
    $('#search_box').autocomplete(options);
}
/**
 * Initializes the tree view with the specified options.
 */
function loadTree() {
    $('#tree').bstreeview({
        data: this.json,
        expandIcon: 'fa fa-angle-down fa-fw',
        collapseIcon: 'fa fa-angle-right fa-fw',
        indent: 1.25,
        parentsMarginLeft: '1.25rem',
        openNodeLinkOnNewTab: true
    });
}
// Selects the element with the ID 'offerExplorerDiv' and assigns it to the variable 'target'
var target = document.querySelector('#offerExplorerDiv');

// create an observer instance
var observer = new MutationObserver(function (mutations) {
    mutations.forEach(function (mutation) {
        if (mutation.type === "attributes" && target.style.display !== "none") {
            //addRefreshButton();
            //loadSearch();
            getOfferData().then((products) => {
                getOfferPaths(products).then((paths) => {
                    this.json = paths;
                    loadTree();
                });
            });
        }
    });
});

// configuration of the observer:
var config = { attributes: true, childList: false, characterData: false };

// pass in the target node, as well as the observer options
if (target) {
    observer.observe(target, config);
}

/**
 * Processes the offer data to generate paths for the tree view.
 * @param {Array} data - The offer data.
 * @returns {Promise<Array>} - A promise that resolves to an array of paths.
 */
function getOfferPaths(data) {
    return new Promise((resolve, reject) => {
        var paths = [];
        if (!data) {
            resolve(paths);
        }
        data.forEach((item) => {
            var pathItem = {};
            pathItem.text = getJournalsSVG() + item.displayName;
            pathItem.id = item.id;
            pathItem.href = 'https://partner.microsoft.com/en-us/dashboard/commercial-marketplace/offers/' + item.id + '/overview';
            if (item.path.length < 2) {
                paths.push(pathItem);
            }
        });

        data.forEach((item) => {
            var pathItem = {};
            if (item.path.length > 1) {
                pathItem.text = getJournalSVG() + item.variantName;
                pathItem.id = item.id;
                pathItem.href = 'https://partner.microsoft.com/en-us/dashboard/commercial-marketplace/offers/' + item.path[0] + '/plans/' + item.id.replace(item.path[0], '') + '/listings';
                var parent = paths.find((element) => element.id == item.path[0]);
                if (parent) {
                    if (!parent.nodes) {
                        parent.nodes = [];
                    }
                    parent.nodes.push(pathItem);
                }
            }
        });
        resolve(paths);
    });
}

/**
 * Adds a refresh button to the offer explorer if it doesn't already exist.
 * The refresh button, when clicked, sends a message to clear offer data and empties the tree element.
 */
function addRefreshButton() {
    if (document.getElementById('refreshButton') !== null) {
        return;
    }
    var refreshButton = document.createElement('button');
    refreshButton.innerHTML = getRecycleSVG();
    refreshButton.id = 'refreshButton';
    refreshButton.className = 'btn refresh-button';
    refreshButton.onclick = async function () {
        chrome.runtime.sendMessage({ action: 'clearOfferData' }, (response) => {
            console.debug('clearOfferData', response);
            this.json = [];
            $('#tree').empty();
        });
    }
    $('div#offerExplorerDiv > h3.title').append(refreshButton);
}
/**
 * Fetches offer data from the background worker.
 * 
 * This function sends a message to the background worker to retrieve offer data
 * stored in the browser's storage. It returns a promise that resolves with the
 * list of products.
 * 
 * @returns {Promise<Array>} A promise that resolves to an array of products.
 */
async function getOfferData() {
    return new Promise((resolve, reject) => {
        // get the settings from storage via the background worker
        chrome.runtime.sendMessage({ action: 'getOfferData' }, (response) => {
            if (!response.success) {
                console.error('Failed to get settings:', response.error);
            }
            resolve(response.data['products']);
        });
    });
};

// Add a listener for changes in the Chrome storage and log the changes
$(document).ready(() => {
    chrome.storage.onChanged.addListener(
        (changes, namespace) => {
            console.debug('storage changed:', changes, namespace);
            if (changes.products) {
                console.log('products changed');
            }
            if (changes.config) {
                console.log('config changed');
            }
        }
    );
});